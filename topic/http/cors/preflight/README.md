### 起因

1. 公司之前所有的接口都走统一的网关【卡门】
2. 不知道什么原因，负责卡门的一堆人离职了， 卡门无人维护了
3. 顺便为了解决之前网关存在的问题，公司新开发新的网关 【彩虹桥】
4. 为了推广【彩虹桥】，所以禁止后端再在【卡门】上编辑。 意味着，卡门接口开始进入全面废弃状态
5. 我这次开发中涉及到了整个收银最核心的一块【开单】，如果这个接口有问题， 基本意味着故障了，我们错误分为线上bug【online】，是必须要日清的， 比【online】更严重的就是【故障】
6. 由于【开单】接口需要增加字段， 而【卡门】 不在允许编辑，导致我们只能迁移【彩虹桥】**最后还是回归到卡门了**



### 问题

1. 数据结构发生改变。 比如原来返回的数据类型是这样的【其实是不太合理的，但是接口比较老】

   ~~~JavaScript
   [camen]
   //正确返回
   {
     resposne: xxx
   }
   // 错误返回
   {
     errorMessage: xxx 
   }
   [rainbow]
   {
     code: xxx,
     message:xxx,
     data:{
       xxx:xxx
     }
   }
   ~~~

2. 理论上，彩虹桥返回的接口才是标准类型， 但是这个老的接口涉及面非常的广，异常处理很多【上面的演示只是很少的一部分】，所以，如果直接迁移新接口， 会导致回归面非常的广。测试投入是有问题的。

3. 彩虹桥会把原来后端返回list类型的值给初始化， 比如一个数组， 原来是空就不返回， 现在为空  返回空数组



### 解决上述问题

1. 商量了下， 为了减少前端这边异常处理的代码， 【返回的code是不确定的】， 所以我们和【彩虹桥】的后端协商， 决定采用【兼容模式】，**在请求头加一个字段， 获取和原来卡门一样的接口**  【是后端为了兼容老接口做的一次努力】 【事实证明是失败的】

2. 也就是增加请求头，类似于， 'access-compatibility-mode':true, 可以，没问题， 我们封装的api请求是可以加请求头的， 类似于

   ~~~JavaScript
   api.post('url', {
     data: {
       
     },
     header: {
        'access-compatibility-mode':true
     },
     extraoption: {
       
     }
   })
   ~~~



### 喜出望外

1. 折腾了很久，【在处理彩虹桥异常模式】【其实是我想多了， 处理异常不应该在业务中处理，应该在通用接口中处理，这样其实很快】， 高高兴兴，一调接口，跑通了
2. 测试投入， 发现，接口报错， 所有请求都发不出去【我开发能发出去了， 是因为我浏览器插件】
3. ![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gegfcl0lspj30i404y0t9.jpg)

并且 我明明是post请求，在浏览器里面查看发现就变成了option请求，我一脸懵， 到处问人【真的丢人，菜的丢人】

4. 针对第三点，先补充的只是【get和post的区别】